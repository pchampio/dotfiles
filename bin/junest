#!/bin/bash
# Collect overlay mounts under /home, excluding '/'
binds=()
while read -r mount_point fs_type; do
    [[ "$fs_type" == "overlay" ]] && [[ "$mount_point" != *"/docker/"* ]] && [[ "$mount_point" != "/" ]] && \
    { [[ "$mount_point" == /home/* ]] \
    || [[ "$mount_point" == /opt/* ]] \
    || [[ "$mount_point" == /mnt/* ]] \
    || [[ "$mount_point" == /media/* ]] \
    || [[ "$mount_point" == /srv/* ]] \
    || [[ "$mount_point" == /s3/* ]] ;} \
    && binds+=( "--bind $mount_point $mount_point" )
done < <(findmnt -l -n -t overlay -o TARGET,FSTYPE)

if [[ $# -eq 0 ]]; then
    echo "DEBUG: Detected overlay mounts to bind: '${binds[*]}'"
fi

# Run junest with binds if any, otherwise without -b
if [[ ${#binds[@]} -gt 0 ]]; then
    "$HOME/.local/share/junest/bin/junest" -b "${binds[*]}" "$@"
else
    # If no command given, default to interactive shell
    if [[ $# -eq 0 ]]; then
        "$HOME/.local/share/junest/bin/junest" bash
    else
        "$HOME/.local/share/junest/bin/junest" "$@"
    fi
fi
