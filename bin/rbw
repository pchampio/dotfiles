#!/bin/bash

bin_path=$HOME/.local/bin/
export PATH="$HOME/.local/bin/":$PATH # ADD RBW-AGENT TO PATH

if [[ ! -f $HOME/.config/rbw/config.json ]]; then
  >&2 echo "Setting up config.."

  # Single read for email and self-hosted URL
  read -r -p 'Enter your Bitwarden login and self-hosted URL (if any) separated by ; : ' textin

  # Split input on ';' and trim spaces/newlines
  email=$(echo "$textin" | cut -d';' -f1 | xargs)
  self_url=$(echo "$textin" | cut -d';' -f2 | xargs)

  >&2 echo "email $email"
  $bin_path/rbw config set email "$email"
  $bin_path/rbw config set pinentry "$HOME/.local/bin/gnupg/bin/pinentry-tty"
  $bin_path/rbw config set lock_timeout $((3600 * 4)) # 4 hours

  if [[ -n "$self_url" ]]; then
    $bin_path/rbw config set base_url "$self_url"
  fi
  # read -r -p 'Enter self-hosted installation identity url, if applicable: ' self_ident_url
  # if [[ ! -z "$self_ident_url" ]]; then
  #   $bin_path/rbw config set identity_url "$self_ident_url"
  # fi
  $bin_path/rbw register
  >&2 echo "Set up complete. Start the agent..."

# else
#   $bin_path/rbw config set pinentry "$HOME/.local/bin/gnupg/bin/pinentry-tty" # TODO REMOVE ME
fi

if [ "$1" = "unlock" ]; then
  $bin_path/rbw unlocked 2> /dev/null > /dev/null
  if [[ $? -ne 0 ]]; then
      $bin_path/rbw unlock
  fi
fi

if [ "$1" = "unlocked" ]; then
    $bin_path/rbw unlocked
    exit $?
fi

if [ "$1" = "lock" ]; then
    $bin_path/rbw lock
    exit $?
fi

$bin_path/rbw unlocked 2> /dev/null > /dev/null
if [[ $? -ne 0 ]]; then
    $bin_path/rbw unlock
fi

$bin_path/rbw "$@"
