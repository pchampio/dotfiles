#!/bin/bash
#
image=git.prr.re/drakirus/rbw:1.0

if [[ ! -f "$HOME/.config/rbw/conf-rbw-$(id -u)"/config.json ]]; then
  echo "Setting up config"
  podman rm rbw-agent-$(id -u) -f || true

  mkdir -p ~/.config/rbw/conf-rbw-$(id -u)
  mkdir -p ~/.cache/rbw/tmp-rbw-$(id -u)

  podman run --rm -ti --tty=true \
    --name=rbw-agent-$(id -u) \
    -v ~/.config/rbw/conf-rbw-$(id -u):/root/.config/rbw/ \
    -v ~/.cache/rbw/tmp-rbw-$(id -u):/root/.cache/rbw/ \
    -e UID=$(id -u) \
    $image \
    setup
fi

if ! podman ps --format '{{.Names}}' | grep -q "^rbw-agent-$(id -u)"; then
  echo "Starting container rbw-agent"
  podman rm rbw-agent-$(id -u) -f || true

  mkdir -p ~/.config/rbw/conf-rbw-$(id -u)
  mkdir -p ~/.cache/rbw/tmp-rbw-$(id -u)

  podman run -it --rm --tty=true \
    --detach=true \
    --name=rbw-agent-$(id -u) \
    -v ~/.config/rbw/conf-rbw-$(id -u):/root/.config/rbw/ \
    -v ~/.cache/rbw/tmp-rbw-$(id -u):/root/.cache/rbw/ \
    $image \
    agent
fi

EDITOR=/usr/bin/vim 

podman exec -ti --tty \
  -e PWINPUT="$PWINPUT" \
  -e EDITOR="$EDITOR" \
  rbw-agent-$(id -u) \
  /usr/local/bin/rbw "$@"
