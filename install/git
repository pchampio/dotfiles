#!/bin/bash

BASEDIR=$(dirname $0)
. $BASEDIR/inc/functions

REQUIRED_GIT_VER="2.19.0"

git_ver=$(git --version | awk '{print $3}')
if [[ "$(printf '%s\n' "$REQUIRED_GIT_VER" "$git_ver" | sort -V | head -n1)" == "$REQUIRED_GIT_VER" ]]; then
    explain "Git version is ($git_ver) skipping local install"
    exit 0
else
    explain "Git version is too old ($git_ver)"
fi

explain "Install latest git version (without https support).."
cd /tmp
\rm -rf git 2> /dev/null || true
git clone https://github.com/git/git --depth=1 || exit
cd git

export NO_OPENSSL=1
export NO_CURL=1
export CFLAGS="${CFLAGS} -static"

run_with_spinner "make configure; ./configure --prefix=$HOME/.local"
run_with_spinner make -j $(nproc)
run_with_spinner "make install; make clean"
rm $HOME/.local/bin/ngit 2> /dev/null || true
mv $HOME/.local/bin/git $HOME/.local/bin/ngit

cat >> $HOME/dotfiles/zsh/priv.zsh << 'EOF'
# Alias git to ngit
git() {
  # If any argument contains "http" or "https"
  if [[ "$*" == *http* ]]; then
    /bin/git "$@"
  else
    $HOME/.local/bin/ngit "$@"
  fi
}
EOF

success "[GIT] Success"
