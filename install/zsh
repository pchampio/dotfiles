#!/bin/bash


BASEDIR=$(dirname $0)
. $BASEDIR/inc/functions

success "[ZSH] Start"

rm -rf ~/.oh-my-zsh/
touch ~/.zsh_history


explain "Install oh-my-zsh"
  export KEEP_ZSHRC='yes'
  [ -f /tmp/.oh-my-zsh.install ] && rm /tmp/.oh-my-zsh.install
  [ -d "$ZSH" ] && rm -rf "$ZSH"
  wget -q https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh -O /tmp/.oh-my-zsh.install
  chmod +x /tmp/.oh-my-zsh.install
  run_with_spinner "export echo exit | ZSH= sh -c /tmp/.oh-my-zsh.install"
  rm /tmp/.oh-my-zsh.install
  if [ -f ~/.zsh-update ]; then
    sudo chown $USER ~/.zsh-update
  fi

explain "Install instant-zsh"
  run_with_spinner curl --progress-bar -fsSL -o ~/.config/instant-zsh.zsh https://gist.github.com/romkatv/8b318a610dc302bdbe1487bb1847ad99/raw

explain "Install zsh-syntax-highlighting"
  run_with_spinner git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ~/.oh-my-zsh/syntax_highlighting --depth 1

explain "Install autosuggestions"
  run_with_spinner git clone https://github.com/zsh-users/zsh-autosuggestions ~/.oh-my-zsh/zsh-autosuggestions --depth 1

explain "Install zsh-completions"
  run_with_spinner git clone https://github.com/zsh-users/zsh-completions ~/.oh-my-zsh/zsh-completions --depth 1

explain "Install zsh-autoquoter"
 run_with_spinner git clone https://github.com/ianthehenry/zsh-autoquoter ~/.oh-my-zsh/custom/plugins/zsh-autoquoter --depth 1

# Remove group/other write permissions to make oh-my-zsh happy
chmod -R go-w ~/.oh-my-zsh 2> /dev/null || true
chmod -R go-w ~/.zshrc ~/.zsh* ~/.zcompdump* ~/.zsh-completions 2> /dev/null || true

# explain "Install git-worktree-switcher"
#  tell curl https://raw.githubusercontent.com/yankeexe/git-worktree-switcher/master/wt > ~/dotfiles/bin/wt
#  chmod +x ~/dotfiles/bin/wt
#  mkdir -p ~/.oh-my-zsh/completions/
#  curl https://raw.githubusercontent.com/yankeexe/git-worktree-switcher/master/completions/_wt_completion > ~/.oh-my-zsh/completions/_wt

[ -f "$HOME/.local/bin/zsh" ] || [ -L "$HOME/.local/bin/zsh" ] && rm "$HOME/.local/bin/zsh"
wherezsh="$(command -v zsh)" # default

MIN_ZSH_VERSION="5.8"
REPLY=n
if command -v zsh >/dev/null 2>&1; then
  ZSH_VERSION=$(zsh --version | awk '{print $2}')
  if [ "$(printf '%s\n' "$ZSH_VERSION" $MIN_ZSH_VERSION | sort -V | head -n1)" = $MIN_ZSH_VERSION ]; then
    explain "Zsh version is ($ZSH_VERSION): Skipping local install"
    tell ln -s "$wherezsh" "$HOME/.local/bin/zsh" || true
  else
    explain "Zsh version is too old ($ZSH_VERSION)"
    REPLY=y
  fi
else
    explain "Zsh is not pre-installed"
    REPLY=y
fi
if [[ $REPLY =~ ^[Yy]$ ]]; then
  explain "Local install of zsh-bin"
  rm -rf /tmp/zsh-bin
  mkdir /tmp/zsh-bin
  wget -q -O /tmp/zsh-bin/install https://raw.githubusercontent.com/romkatv/zsh-bin/master/install
  run_with_spinner sh /tmp/zsh-bin/install -d $HOME/.local/ -e no
  wherezsh=$HOME/.local/bin/zsh
fi

$wherezsh -c "zcompile $HOME/.config/instant-zsh.zsh"

success "[ZSH] Success"
